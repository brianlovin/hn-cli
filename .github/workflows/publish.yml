name: Publish to npm

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for OIDC trusted publishing
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "latest"

      - run: bun install

      # Build platform binaries (cross-compilation)
      - name: Build platform binaries
        run: bun run build:binaries

      # Also build the regular dist for Bun users
      - name: Build dist
        run: bun run build

      - run: bun run test
      - run: bun run typecheck

      - uses: actions/setup-node@v4
        with:
          node-version: '24.x'
          registry-url: 'https://registry.npmjs.org'

      # Publish platform packages first (they must exist before main package)
      # Copy npmrc to each package directory so npm finds auth when publishing from subdirectories
      - name: Publish platform packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          for dir in dist/binaries/*/; do
            name=$(basename "$dir")
            echo "Publishing $name..."
            cp "$NPM_CONFIG_USERCONFIG" "$dir/.npmrc"
            (cd "$dir" && npm publish --provenance --access public) || echo "Package may already exist, continuing..."
          done

      # Remove binaries from dist before publishing main package (they're in separate packages)
      - name: Clean binaries from dist
        run: rm -rf dist/binaries

      # Then publish the main package
      - name: Publish main package
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --provenance --access public
